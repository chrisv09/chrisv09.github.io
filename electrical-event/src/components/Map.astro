---
interface Props {
  nodes: Array<{ id: string; lat: number; lon: number }>;
  centerLat?: number;
  centerLon?: number;
}

const { nodes, centerLat: propCenterLat, centerLon: propCenterLon } = Astro.props;

// Use center from guess locations when provided; else fall back to OSM nodes centroid
const centerLat = propCenterLat ?? (nodes.length ? nodes.reduce((sum, n) => sum + n.lat, 0) / nodes.length : -36.965);
const centerLon = propCenterLon ?? (nodes.length ? nodes.reduce((sum, n) => sum + n.lon, 0) / nodes.length : 174.905);
---

<div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
  <button id="add-random" type="button">Make a guess</button>
  <small>Click map to place base point, press random to add a dot 100m away, then press Connect to draw a line.</small>
</div>

<div id="basicMap" style="width: 100%; height: 90%; position: relative;" data-nodes={JSON.stringify(nodes)} data-center-lat={centerLat} data-center-lon={centerLon}>
  <!-- Timer badge in top-right (does not block map interaction) -->
  <div id="countdown-timer" style="display: none; position: absolute; top: 8px; right: 8px; z-index: 90; pointer-events: none; background-color: rgba(0, 0, 0, 0.65); color: white; font-size: 24px; font-weight: bold; padding: 8px 14px; border-radius: 8px; min-width: 48px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
    <span id="countdown-number">30</span>
  </div>
  <!-- Overlay for displaying guess result (shown only when timer hits 0) -->
  <div id="guess-overlay" style="display: none; position: absolute; top: 80%; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 100; border-radius: 8px; flex-direction: column; align-items: center; justify-content: center; gap: 16px;">
    <div style="text-align: center;">
      <div id="distance-display" style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 8px;"></div>
      <p id="overlay-message" style="color: white; margin: 0; font-size: 14px;">Good guess!</p>
      <!-- Display stars depending on distance -->
      <div id="stars" style="font-size: 32px; color: gold;"></div>
    
    </div>
    <button id="next-round" type="button" style="padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Next round</button>
  </div>
</div>

<style>
  @import 'ol/ol.css';

  #basicMap {
    border: 4px solid white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    overflow: hidden;
  }
</style>

<script is:inline src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
<script is:inline type="module" src="/client/map-client.js"></script>