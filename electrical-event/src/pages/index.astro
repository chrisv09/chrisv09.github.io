---
import Welcome from '../components/Welcome.astro';
import Layout from '../layouts/Layout.astro';
import Map from '../components/Map.astro';
import { guessImages as rawImages, type GuessImage } from '../data/guess-images';

function shuffle<T>(array: T[]): T[] {
  const out = [...array];
  for (let i = out.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [out[i], out[j]] = [out[j], out[i]];
  }
  return out;
}
const images = shuffle(rawImages);

// Center the map on guess locations (not OSM nodes) so the game area is in view
const centerLon = images.length ? images.reduce((s, i) => s + i.lon, 0) / images.length : 174.905;
const centerLat = images.length ? images.reduce((s, i) => s + i.lat, 0) / images.length : -36.965;

const url = 'https://api.openstreetmap.org/api/0.6/map?bbox=173.74,-36.93,174.92,-36.83';
let nodes: Array<{ id: string; lat: number; lon: number }> = [];
try {
  const res = await fetch(url, { headers: { 'User-Agent': 'ChrisV Valentines App (contact via GitHub)' } });
  if (!res.ok) {
    console.error(`OpenStreetMap API error: ${res.status} ${res.statusText}`);
  }
  const xml = await res.text();
  const matches = Array.from(xml.matchAll(/<node[^>]*id="(\d+)"[^>]*lat="([^"]+)"[^>]*lon="([^"]+)"/g));
  nodes = matches.map(m => ({ id: m[1], lat: parseFloat(m[2]), lon: parseFloat(m[3]) }));
  console.log(`Fetched ${nodes.length} nodes from OpenStreetMap.`);
} catch (err) {
  console.error('Error fetching map data:', err);
}
---

<Layout>
  <div class="container">
    <!-- Left half: Map -->
    <div class="left-half">
      <Map {nodes} centerLat={centerLat} centerLon={centerLon} />
    </div>
    
    <!-- Right half: Centered Image -->
    <div class="right-half">
      <div class="image-wrapper">
        <img 
          id="guessImage" 
          src={images[0].url} 
          alt="A bird." 
          width="300" 
          data-images={JSON.stringify(images)} 
        />
        <div id="image-loading" class="image-loading" aria-live="polite">
          <span class="image-loading-spinner"></span>
          <span class="image-loading-text">Loadingâ€¦</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Start overlay: covers both halves until user enters password and clicks Start -->
  <div id="start-overlay" class="start-overlay">
    <div class="start-overlay-content">
      <h1 class="start-title">ChrizGuessr!</h1>
      <p class="start-message">What's my favourite colour?</p>
      <form id="start-form" class="start-form">
        <input type="password" id="start-password" class="start-password" placeholder="Password" autocomplete="off" />
        <p id="start-error" class="start-error" aria-live="polite"></p>
        <button type="submit" class="start-button" id="start-button">Start</button>
      </form>
    </div>
  </div>
  
  <script is:inline src="/client/image-rotator.js"></script>
  <script is:inline>
    (function() {
      const PASSWORD = 'dark green';
      const overlay = document.getElementById('start-overlay');
      const form = document.getElementById('start-form');
      const passwordInput = document.getElementById('start-password');
      const errorEl = document.getElementById('start-error');

      function dismissStart() {
        if (!overlay) return;
        overlay.classList.add('start-overlay--hidden');
        window.setTimeout(function() {
          overlay.style.display = 'none';
          window.dispatchEvent(new CustomEvent('game:start'));
          var loadingEl = document.getElementById('image-loading');
          var img = document.getElementById('guessImage');
          if (img && loadingEl) {
            if (img.complete) {
              window.dispatchEvent(new CustomEvent('guessImage:loaded'));
            } else {
              loadingEl.classList.add('is-visible');
              img.addEventListener('load', function onLoad() {
                window.dispatchEvent(new CustomEvent('guessImage:loaded'));
              }, { once: true });
            }
          }
        }, 300);
      }

      function showError(msg) {
        if (errorEl) {
          errorEl.textContent = msg;
          errorEl.classList.add('start-error--visible');
        }
      }

      function clearError() {
        if (errorEl) {
          errorEl.textContent = '';
          errorEl.classList.remove('start-error--visible');
        }
      }

      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          clearError();
          var value = passwordInput ? passwordInput.value.trim() : '';
          if (value === PASSWORD) {
            dismissStart();
          } else {
            showError('Wrong password');
          }
        });
      }
    })();
  </script>
</Layout>

<style>
  .container {
    display: flex;
    height: 100vh;
    width: 100vw;
  }

  .left-half {
    flex: 1;
    height: 100%;
  }

  .right-half {
    flex: 1;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f5f5f5; /* Optional: subtle background to distinguish halves */
  }

  .image-wrapper {
    position: relative;
    border: 4px solid white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    overflow: hidden;
  }

  .image-wrapper img {
    display: block;
    max-width: 100%;
    height: auto;
  }

  .image-loading {
    display: none;
    position: absolute;
    inset: 0;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 0.75rem;
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
  }

  .image-loading.is-visible {
    display: flex;
  }

  .image-loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: image-loading-spin 0.8s linear infinite;
  }

  .image-loading-text {
    font-size: 0.9rem;
  }

  @keyframes image-loading-spin {
    to { transform: rotate(360deg); }
  }

  /* Start overlay: full screen over both halves */
  .start-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    color: #fff;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .start-overlay--hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }

  .start-overlay-content {
    text-align: center;
    padding: 2rem;
  }

  .start-form {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  .start-password {
    padding: 10px 14px;
    font-size: 1rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    width: 180px;
    outline: none;
  }

  .start-password::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .start-password:focus {
    border-color: #e94560;
  }

  .start-error {
    margin: 0;
    font-size: 0.9rem;
    color: #ff6b6b;
    min-height: 1.4em;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .start-error--visible {
    opacity: 1;
  }

  .start-overlay-content .start-button {
    cursor: pointer;
    margin-top: 0.25rem;
    padding: 14px 32px;
    font-size: 1.25rem;
    font-weight: bold;
    color: #1a1a2e;
    background: #e94560;
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(233, 69, 96, 0.4);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .start-overlay-content .start-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(233, 69, 96, 0.5);
  }

  .start-title {
    font-size: 2.5rem;
    margin: 0 0 0.5rem;
    letter-spacing: 0.02em;
  }

  .start-message {
    font-size: 1rem;
    opacity: 0.9;
    margin: 0;
  }
</style>