---
import Welcome from '../components/Welcome.astro';
import Layout from '../layouts/Layout.astro';
import Map from '../components/Map.astro';
import { guessImages as rawImages, type GuessImage } from '../data/guess-images';

function shuffle<T>(array: T[]): T[] {
  const out = [...array];
  for (let i = out.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [out[i], out[j]] = [out[j], out[i]];
  }
  return out;
}
const images = shuffle(rawImages);

const hasAnyExtraQuestion = images.some((img) => img.question && img.answer);

// Center the map on guess locations (not OSM nodes) so the game area is in view
const centerLon = images.length ? images.reduce((s, i) => s + i.lon, 0) / images.length : 174.905;
const centerLat = images.length ? images.reduce((s, i) => s + i.lat, 0) / images.length : -36.965;

const url = 'https://api.openstreetmap.org/api/0.6/map?bbox=173.74,-36.93,174.92,-36.83';
let nodes: Array<{ id: string; lat: number; lon: number }> = [];
try {
  const res = await fetch(url, { headers: { 'User-Agent': 'ChrisV Valentines App (contact via GitHub)' } });
  if (!res.ok) {
    console.error(`OpenStreetMap API error: ${res.status} ${res.statusText}`);
  }
  const xml = await res.text();
  const matches = Array.from(xml.matchAll(/<node[^>]*id="(\d+)"[^>]*lat="([^"]+)"[^>]*lon="([^"]+)"/g));
  nodes = matches.map(m => ({ id: m[1], lat: parseFloat(m[2]), lon: parseFloat(m[3]) }));
  console.log(`Fetched ${nodes.length} nodes from OpenStreetMap.`);
} catch (err) {
  console.error('Error fetching map data:', err);
}
---

<Layout>
  <div class="container">
    <!-- Left half: Map -->
    <div class="left-half">
      <Map {nodes} centerLat={centerLat} centerLon={centerLon} />
    </div>
    
    <!-- Right half: Centered Image + extra question underneath -->
    <div class="right-half">
      <div class="image-wrapper">
        <img 
          id="guessImage" 
          src={images[0].url} 
          alt="A bird." 
          width="300" 
          data-images={JSON.stringify(images)} 
        />
        <div id="image-loading" class="image-loading" aria-live="polite">
          <span class="image-loading-spinner"></span>
          <span class="image-loading-text">Loadingâ€¦</span>
        </div>
      </div>
      {hasAnyExtraQuestion && (
        <div id="extra-question" class="extra-question" style="display: none;">
          <h2 class="extra-question-title">Extra Points Question</h2>
          <p id="extra-question-text" class="extra-question-text"></p>
          <form id="extra-question-form" class="extra-question-form">
            <input type="text" id="extra-question-answer" class="extra-question-answer" placeholder="Answer" autocomplete="off" />
            <button type="submit" class="extra-question-button" id="extra-question-button">Submit</button>
          </form>
        </div>
      )}
    </div>
  </div>

  <!-- Start overlay: covers both halves until user enters password and clicks Start -->
  <div id="start-overlay" class="start-overlay">
    <div class="start-overlay-content">
      <h1 class="start-title">ChrizGuessr!</h1>
      <p class="start-message">What's my favourite colour?</p>
      <form id="start-form" class="start-form">
        <input type="password" id="start-password" class="start-password" placeholder="Password" autocomplete="off" />
        <p id="start-error" class="start-error" aria-live="polite"></p>
        <button type="submit" class="start-button" id="start-button">Start</button>
      </form>
    </div>
  </div>
  
  <script is:inline src="/client/image-rotator.js"></script>

  <!-- Question logic -->
  <!-- Question logic -->
<script is:inline>
  (function() {
    const form = document.getElementById('extra-question-form');
    const guess = document.getElementById('extra-question-answer');
    const feedbackText = document.getElementById('extra-question-text');

    function syncExtraQuestion() {
      var block = document.getElementById('extra-question');
      if (!block) return;
      var cur = window.getCurrentImage && window.getCurrentImage();
      var textEl = document.getElementById('extra-question-text');
      var inputEl = document.getElementById('extra-question-answer');
      if (feedbackText) feedbackText.style.color = "#555"; 
      if (cur && cur.question && cur.answer) {
        block.style.display = '';
        if (textEl) textEl.textContent = cur.question;
        if (inputEl) { 
          inputEl.value = ''; 
          inputEl.dataset.expectedAnswer = cur.answer;
          inputEl.disabled = false; // Re-enable input for new question
        }
      } else {
        block.style.display = 'none';
        if (inputEl) { 
          inputEl.value = ''; 
          delete inputEl.dataset.expectedAnswer; 
        }
      }
    }
    
    window.addEventListener('game:start', syncExtraQuestion);
    window.addEventListener('guessImage:loaded', syncExtraQuestion);
    if (document.readyState === 'complete') syncExtraQuestion();
    else window.addEventListener('load', syncExtraQuestion);

    if (form && guess && feedbackText) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var cur = window.getCurrentImage && window.getCurrentImage();
        if (!cur || !cur.answer) return; // Guard clause if no current image/answer
        
        var value = guess.value.trim();
        if (value.toLowerCase() === cur.answer.toLowerCase()) {
          console.log("correct"); 
          feedbackText.textContent = "Correct! +5000 points!";
          feedbackText.style.color = "#28a745"; 
          window.dispatchEvent(new CustomEvent('extraQuestion:correct'));
        } else {
          console.log("incorrect");
          feedbackText.textContent = "Incorrect! It was " + cur.answer;
          feedbackText.style.color = "#dc3545";
        }
        guess.disabled = true; // Disable input after submitting (use disabled, not contentEditable)
      });
    }
  })();
</script>

  <!-- Start overlay logic -->
  <script is:inline>
    (function() {
      const PASSWORD = 'dark green';
      const overlay = document.getElementById('start-overlay');
      const form = document.getElementById('start-form');
      const passwordInput = document.getElementById('start-password');
      const errorEl = document.getElementById('start-error');

      function dismissStart() {
        if (!overlay) return;
        overlay.classList.add('start-overlay--hidden');
        window.setTimeout(function() {
          overlay.style.display = 'none';
          window.dispatchEvent(new CustomEvent('game:start'));
          var loadingEl = document.getElementById('image-loading');
          var img = document.getElementById('guessImage');
          if (img && loadingEl) {
            if (img.complete) {
              window.dispatchEvent(new CustomEvent('guessImage:loaded'));
            } else {
              loadingEl.classList.add('is-visible');
              img.addEventListener('load', function onLoad() {
                window.dispatchEvent(new CustomEvent('guessImage:loaded'));
              }, { once: true });
            }
          }
        }, 300);
      }

      function showError(msg) {
        if (errorEl) {
          errorEl.textContent = msg;
          errorEl.classList.add('start-error--visible');
        }
      }

      function clearError() {
        if (errorEl) {
          errorEl.textContent = '';
          errorEl.classList.remove('start-error--visible');
        }
      }

      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          clearError();
          var value = passwordInput ? passwordInput.value.trim().toLowerCase() : '';
          if (value === PASSWORD) {
            dismissStart();
          } else {
            showError('Wrong password');
          }
        });
      }
    })();
  </script>
</Layout>

<style>
  .container {
    display: flex;
    height: 100vh;
    width: 100vw;
  }

  .left-half {
    flex: 1;
    height: 100%;
  }

  .right-half {
    flex: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 1.5rem;
    padding: 1.5rem;
    background-color: #f5f5f5;
    overflow-y: auto; /* Allow scrolling if content overflows */
  }

  .image-wrapper {
    position: relative;
    border: 4px solid white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    overflow: hidden;
    max-width: 100%; /* Prevent overflow */
  }

  .image-wrapper img {
    display: block;
    max-width: 100%;
    height: auto;
    max-height: 50vh; /* Limit image height on mobile */
  }

  .extra-question {
    width: 100%;
    max-width: 320px;
    padding: 1rem 1.25rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 2px solid #e0e0e0;
  }

  .extra-question-title {
    margin: 0 0 0.5rem;
    font-size: 1.1rem;
    color: #333;
  }

  .extra-question-text {
    margin: 0 0 0.75rem;
    font-size: 0.95rem;
    color: #555;
  }

  .extra-question-form {
    display: flex;
    gap: 0.5rem;
    align-items: stretch;
    flex-wrap: wrap; /* Allow form to wrap on small screens */
  }

  .extra-question-answer {
    flex: 1;
    min-width: 120px; /* Prevent input from getting too small */
    padding: 8px 12px;
    font-size: 0.95rem;
    border: 2px solid #ddd;
    border-radius: 6px;
    outline: none;
  }

  .extra-question-answer:focus {
    border-color: #007bff;
  }

  .extra-question-button {
    padding: 8px 16px;
    font-size: 0.95rem;
    font-weight: 600;
    color: white;
    background: #007bff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap; /* Keep button text on one line */
  }

  .extra-question-button:hover {
    background: #0069d9;
  }

  .image-loading {
    display: none;
    position: absolute;
    inset: 0;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 0.75rem;
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
  }

  .image-loading.is-visible {
    display: flex;
  }

  .image-loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: image-loading-spin 0.8s linear infinite;
  }

  .image-loading-text {
    font-size: 0.9rem;
  }

  @keyframes image-loading-spin {
    to { transform: rotate(360deg); }
  }

  /* Start overlay: full screen over both halves */
  .start-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    color: #fff;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .start-overlay--hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }

  .start-overlay-content {
    text-align: center;
    padding: 2rem;
    max-width: 90vw; /* Prevent content from being too wide */
  }

  .start-form {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    margin-top: 1rem;
    width: 100%;
  }

  .start-password {
    padding: 10px 14px;
    font-size: 1rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    width: 180px;
    max-width: 100%; /* Responsive width */
    outline: none;
  }

  .start-password::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .start-password:focus {
    border-color: #3aaa3b;
  }

  .start-error {
    margin: 0;
    font-size: 0.9rem;
    color: #ff6b6b;
    min-height: 1.4em;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .start-error--visible {
    opacity: 1;
  }

  .start-overlay-content .start-button {
    cursor: pointer;
    margin-top: 0.25rem;
    padding: 14px 32px;
    font-size: 1.25rem;
    font-weight: bold;
    color: #1a1a2e;
    background: #e94560;
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(233, 69, 96, 0.4);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .start-overlay-content .start-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(233, 69, 96, 0.5);
  }

  .start-title {
    font-size: 2.5rem;
    margin: 0 0 0.5rem;
    letter-spacing: 0.02em;
  }

  .start-message {
    font-size: 1rem;
    opacity: 0.9;
    margin: 0;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
      height: 100vh;
      overflow: hidden; /* Prevent body scroll, handle internally */
    }

    .left-half {
      flex: none; /* Remove flex: 1 */
      height: 50vh; /* Top half */
      width: 100%;
      min-height: 250px; /* Minimum map size */
    }

    .right-half {
      flex: none; /* Remove flex: 1 */
      height: 50vh; /* Bottom half */
      width: 100%;
      padding: 1rem;
      gap: 1rem;
      justify-content: center; /* Center content vertically */
    }

    .image-wrapper {
      max-height: 35vh; /* Limit image height */
    }

    .image-wrapper img {
      max-height: 35vh;
      width: auto;
      margin: 0 auto; /* Center image */
    }

    .extra-question {
      max-width: 100%;
      padding: 0.75rem 1rem;
    }

    .extra-question-title {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .extra-question-text {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .extra-question-form {
      gap: 0.4rem;
    }

    .extra-question-answer {
      padding: 6px 10px;
      font-size: 0.9rem;
    }

    .extra-question-button {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    .start-title {
      font-size: 2rem; /* Smaller title on mobile */
    }

    .start-overlay-content {
      padding: 1.5rem;
    }
  }

  /* Extra small devices */
  @media (max-width: 480px) {
    .left-half {
      height: 45vh;
      min-height: 200px;
    }

    .right-half {
      height: 55vh;
      padding: 0.75rem;
      gap: 0.75rem;
    }

    .image-wrapper {
      max-height: 30vh;
    }

    .image-wrapper img {
      max-height: 30vh;
    }

    .extra-question-title {
      font-size: 0.95rem;
    }

    .extra-question-text {
      font-size: 0.85rem;
    }

    .start-title {
      font-size: 1.75rem;
    }

    .start-message {
      font-size: 0.9rem;
    }

    .start-password {
      width: 160px;
      padding: 8px 12px;
    }

    .start-overlay-content .start-button {
      padding: 12px 24px;
      font-size: 1.1rem;
    }
  }

  /* Landscape mode on mobile - side by side if enough height */
  @media (max-width: 768px) and (min-height: 500px) and (orientation: landscape) {
    .container {
      flex-direction: row;
    }

    .left-half {
      height: 100vh;
      flex: 1;
    }

    .right-half {
      height: 100vh;
      flex: 1;
    }
  }
</style>